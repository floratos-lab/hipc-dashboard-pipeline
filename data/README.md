## Directory Overview 
Files utilized and generated by the data processing pipeline are stored in the following folders:
* **./source_curations**: source curation spreadsheets, as provided by curators.
    
* **./standardized_curations**: A fully denormalized representation of the standardized curated data.  
  This is the state from which all other files are created, i.e. the convenience files and release files.  
  The denormalized files can easily be read into a spreadsheet or database for further analysis.  All rows 
  derived from one signature share the same row key, to allow identification and reconstruction of signatures as desired.

* **./reference_files**: resources used to support the standardization process, including controlled vocabularies from
  external sources and mapping files maintained by the project.
    
* **./release_files**: Dashboard release files. These are
  transformed, partially denormalized spreadsheet files generated from the standardized
  curations. They are formatted as needed for uploading to the
  Dashboard.  Key controlled vocabulary data columns, such as exposure_material_id and target_pathogen_id, 
  are not denormalized, but instead each entry for one signature is placed in a separate column.  The 
  response_component column is always denormalized, e.g. to one gene symbol per row.  Further details below 
  under "Release File Format".

* **./convenience_files**: 
  (1) the standardized curations cast back into the format of the curation templates for easy inspection.  Row keys are included to allow signature identification.
  (2) signature response component (e.g. gene symbols, cell-types) files in Broad Inst. GMT format.  Row keys are included to allow signature identification.
    
* **NOTE on row_keys**: row keys are formed by concatenating the following: PMID, count of this signature within that PMID, and the original row within the curation sheet 
  in which the signature was curated.
        

## Pipeline Input: Original Curation Template Data (./source_curations)
Unprocessed, curated data is placed as tab-delimited spreadsheet files in ./source_curations, 
one file per signature type and per response component type.  These files are the input for the pipeline.
These are currently:

**Vaccine:**
* **hipc_vaccine - gene_expression.tsv**
* **hipc_vaccine - cell_type_frequency.tsv**

**Infection (COVID-19):**
* **Odak_2020_pmid_32650275 - covid19.tsv**
* **COVID-19 curation template - example curation.tsv** - from Arunachalam et al. (2020), used as example on the [community.covid-signatures.org example annotation page](http://community.covid-signatures.org/example_annotation).

## Reference and Ancillary Data (./reference_files)
The quality control and standardization steps in the pipeline utilize data retrieved from outside resources:

* **Homo_sapiens.gene_info.gz** - gene file downloaded from NCBI.
* **hgnc_complete_set.RData** - HGNC data file downloaded from EBI.

We additionally maintain, and incrementally update as needed, a number of files used 
to facilitate various steps in the data processing pipeline:

* **cell_type_frequency-response_components_mapping.txt** - maps cell-type strings to official cell ontology and protein ontology terms (text export for pipeline).
* **cell_type_frequency-response_components_mapping.xlsx** - maps cell-type strings to official cell ontology and protein ontology terms (primary copy).
* **manual_gene_symbol_corrections.txt** - a manually maintained file containing special gene symbol mappings
* **vaccine_years.txt** - a mapping of influenza vaccines by year to their viral components (text export for pipeline)
* **vaccine_years.xlsx** - a mapping of influenza vaccines by year to their viral components (primary copy)

Pubmed data downloaded by the pipeline, by exposure type and response component type:
* **vac_cell_type-titles_and_dates_df.RData**
* **vac_gene_expression-titles_and_dates_df.RData**
* **inf_cell_type-titles_and_dates_df.RData**
* **inf_gene_expression-titles_and_dates_df.RData**

## Standardized Curation Data (./standardized_curations)
A fully denormalized representation of the standardized curated data. This is the state from which all other files are created, i.e. the convenience files and release files. The denormalized files can easily be read into a spreadsheet or database for further analysis. All rows derived from one signature share the same row key, to allow identification and reconstruction of signatures as desired.
* **inf_cell_type-standardized_denormalized.tsv.gz**  (cell-type signatures from infection)
* **inf_gene_expression-standardized_denormalized.tsv.gz** (gene expression signatures from infection)
* **vac_cell_type-standardized_denormalized.tsv.gz** (cell-type signatures from vaccination)
* **vac_gene_expression-standardized_denormalized.tsv.gz** (gene expression signatures from vaccination)

The R session_info.txt files documenting the software used to generate these signatures are also located here.


## Convenience Files (./convenience_files)
Cell-type response component files (vaccination = "vac", infection = "inf").  Examples given for vaccine exposure types:
* **vac_cell_type-standardized_curation_template.tsv** - updated cell-type data in text format
* **vac_cell_type-response_components.gmt.txt** - a list of each fully-qualified cell-type (including additional 
protein markers etc.) in Broad GMT format.  The additional markers are separated from the primary cell 
type by an ampersand symbol "&". For example, "alpha-beta T cell & IFNG-, TNF-a+, IL-2+".
* **vac_gene_expression-standardized_curation_template.tsv** - updated gene data in text format
* **vac_gene_expression-response_components.gmt.txt** - a list of all gene response components for each signature row in Broad GMT format

## Pipeline Output Files (./release_files)
This directory contains the Dashboard data release files generated by the R pipeline script.
The files are tab-delimited and named using the pattern 
"hipc_<type>_<PMID>_<number>, where type is the type of response component 
("gene"; or "ctf" for cell-type frequency), PMID is the PMID of the source publication, 
and "number" is the sequential count of this signature of this type within the publication.
	
Immune signatures describing changes in gene expression are placed in the subdirectory "./release_files/hipc_vac_gene/" or 
"./release_files/hipc_inf_gene/".  
* Example: for the file **hipc_vac_gene_21357945_1.txt**, "vac" indicates a vaccination signature, 
"21357945" is the PMID of the publication, and "1" indicates the first signature of this type from that PMID.
	
Immune signatures involving Cell-type abundance are placed in the subdirectory 
"./release_files/hipc_vac_ctf/" or "./release_files/hipc_inf_ctf/".
* Example: for the file **hipc_vac_ctf_26726811_1.txt**, "vac" indicates a vaccination signature, 
"ctf" indicates type "cell-type frequency", "26726811" is the PMID, and "1" indicates the 
first signature of this type for that PMID.

### Release File Format
The Dashboard load files contain the same columns as described in the curation document, 
with some additions to support the requirements of the Dashboard itself and to preserve original 
curated values for fields updated by the pipeline. Each file represents one signature in a 
denormalized manner. Because the "response_component" field for one signature many contain up 
to e.g. thousands of gene symbols, this element of the signature is treated differently than all other elements.
* multi-valued "subject" fields other than "response_component" (genes or vaccines) are 
split into as many columns as needed to represent each entry in single-valued fashion.  
For example, a spreadsheet target_pathogen field containing three pathogens would be split 
into three separate columns on the same row, "target_pathogen_taxonid_1", "target_pathogen_taxonid_2" and 
"target_pathogen_taxonid_3".  This currently applies to the fields "tissue_type_term_id", "exposure_material_id" and "target_pathogen_taxonid".
* "response_component" and "comparison" fields are split into a new row for each entry. For example, a signature 
with 100 genes will be expanded to 100 rows, each with 1 gene symbol in the 
response_component column. All other columns will be the same for each row. 
(This aspect of the Dashboard design allows in principle additional unique supporting evidence 
to be stored for each response_component (e.g. p-values for genes), however the current HIPC signatures 
curation project is not collecting data at this level of detail). 
* The original curated values for response_component appear in the "response_component_original" column.

The following additional fields are added by the pipeline
* **response_comp_orig_cnt** - the number of response components in originally curated signature (e.g. gene symbols)
* **response_comp_cnt** - the number of response components in the updated signature.
* **subm_obs_id** - the sequential count of a signature within all signatures of this type for a 
particular publication_reference_id (PMID).      
* **uniq_obs_id** - the original row number of a signature in the curation sheet.         
* **row_key** - the concatenation of the publication_reference_id, the subm_obs_id and the uniq_obs_id.
	
Files containing just the complete list of response components for each signature are located in a 
further subdirectory, "files", for reach response component type, e.g. "./release_files/hipc_gene/files".  
An example is the file **hipc_gene_sig_21357945_3.txt** which lists six genes, one per line, 
that make up the third signature for that PMID.

### Log Files
An additional directory (not checked-in to GitHub), "logfiles" is created.  After the script has 
run, this directory contains a number of files tracing the data transformations and final summary data.
